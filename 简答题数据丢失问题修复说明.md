# 简答题数据丢失问题修复说明

## 问题分析

### 根本原因
1. 学生提交简答题答案时，系统会执行以下流程：
   - 保存测验结果到 `lesson_completions` 表
   - 触发数据库触发器更新课程进度
   - 调用 `refreshCourseData()` 刷新整个课程数据

2. 问题出现在第3步：
   - `refreshCourseData` 会使缓存失效并重新获取所有课程数据
   - 在某些情况下，这个刷新操作可能与其他并发操作冲突
   - 导致数据库中的课程内容被覆盖为 null

### 影响范围
- 简答题提交后，整个课程的模块和课时数据可能丢失
- 数据库中的 `lessons` 表内容可能变为 null
- 数据丢失后无法恢复（除非有备份）

## 解决方案

### 1. 创建配置控制系统
创建了 `src/config/appConfig.ts` 配置文件，允许灵活控制自动刷新行为：

```typescript
export const appConfig = {
  courseData: {
    autoRefreshAfterCompletion: false,  // 课时完成后是否自动刷新
    autoRefreshAfterQuizSubmit: false,  // 测验提交后是否自动刷新
  },
  debug: {
    logRefreshEvents: true,  // 是否记录刷新事件日志
  }
};
```

### 2. 修改的文件
- `src/pages/course/components/LessonContent.tsx`
  - 两个 `handleQuizSubmit` 函数现在使用配置控制刷新
  - 添加了调试日志
  
- `src/components/course/lessons/LessonCompletionButton.tsx`
  - `handleToggleComplete` 函数现在使用配置控制刷新
  
### 3. 默认行为
- 测验提交后**不会**自动刷新课程数据
- 课时完成后**不会**自动刷新课程数据
- 数据仍然会正确保存到数据库
- 用户需要手动刷新页面来查看最新进度

## 使用指南

### 对于开发者
1. 如果需要启用自动刷新，修改配置文件：
   ```typescript
   autoRefreshAfterQuizSubmit: true,  // 启用测验提交后的自动刷新
   ```

2. 监控控制台日志来调试刷新行为：
   - "根据配置执行自动刷新"
   - "根据配置跳过自动刷新"

### 对于用户
1. 提交简答题后，答案会自动保存
2. 看到"测验答案已保存"提示即表示成功
3. 如需查看最新的学习进度，可以：
   - 手动刷新页面
   - 返回课程列表再重新进入

## 后续优化建议

### 短期方案
1. 保持当前配置（禁用自动刷新）
2. 监控系统稳定性
3. 收集用户反馈

### 长期方案
1. 优化数据刷新机制，使用更细粒度的更新
2. 实现乐观更新（Optimistic Updates）
3. 添加数据冲突检测和解决机制
4. 实现实时数据同步而非全量刷新

## 回滚方案
如果需要恢复原有行为：
1. 将配置文件中的相关选项设置为 `true`
2. 或者直接修改代码，恢复 `refreshCourseData()` 调用

## 注意事项
- 这是一个临时性的安全修复
- 根本解决方案需要重构数据同步机制
- 建议定期备份数据库
- 在生产环境部署前充分测试 