# è¯¾ç¨‹åŠ è½½é—®é¢˜ä¿®å¤è®¡åˆ’ä¹¦

## é—®é¢˜åˆ†ææ€»ç»“

### å½“å‰é”™è¯¯ç°è±¡
1. **AbortError**: `AbortError: signal is aborted without reason` åœ¨ src/integrations/supabase/client.ts:25 å‘ç”Ÿ
2. **é‡å¤è¯·æ±‚**: `course_enrollments` æŸ¥è¯¢è¢«å¤§é‡é‡å¤æ‰§è¡Œ
3. **Timer å†²çª**: å¤§é‡ "Timer 'getCourseDetails' already exists" è­¦å‘Š
4. **æ€§èƒ½é—®é¢˜**: é¡µé¢åŠ è½½æ—¶åŒä¸€æ¥å£è¢«è°ƒç”¨å¤šæ¬¡
5. **ğŸš¨ è¯¾ç¨‹æ•°æ®æ··ä¹±**: ç‚¹å‡»èœœèœ‚è¯¾ç¨‹å´åŠ è½½ç‹—ç‹—è¯¾ç¨‹çš„ä¿¡æ¯ï¼ˆæ–°å‘ç°çš„å…³é”®é—®é¢˜ï¼‰

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. ğŸ”¥ é”™è¯¯çš„è¯¾ç¨‹æ•°æ®åˆ·æ–°é€»è¾‘ï¼ˆæ–°å‘ç° - æœ€é«˜ä¼˜å…ˆçº§ï¼‰
**é—®é¢˜ä½ç½®**: `src/pages/course/CoursePage.tsx:74-78`
```typescript
useEffect(() => {
  if (lessonId) {
    refreshCourseData(); // â† é”™è¯¯ï¼lessonIdå˜åŒ–ä¸åº”è¯¥åˆ·æ–°è¯¾ç¨‹æ•°æ®
  }
}, [lessonId, refreshCourseData]);
```

**é—®é¢˜åˆ†æ**:
- å½“ç”¨æˆ·ä»ä¸€ä¸ªè¯¾ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¯¾ç¨‹æ—¶ï¼ŒlessonIdçš„å˜åŒ–è§¦å‘äº†refreshCourseData()
- ç”±äºReact Queryçš„ç¼“å­˜æœºåˆ¶å’ŒstaleTimeè®¾ç½®ï¼Œå¯èƒ½è¿”å›äº†é”™è¯¯çš„ç¼“å­˜æ•°æ®
- è¿™å¯¼è‡´ç”¨æˆ·ç‚¹å‡»èœœèœ‚è¯¾ç¨‹ï¼Œå´çœ‹åˆ°äº†ç‹—ç‹—è¯¾ç¨‹çš„å†…å®¹

**å½±å“**: è¿™æ˜¯å¯¼è‡´è¯¾ç¨‹æ•°æ®æ··ä¹±çš„ç›´æ¥åŸå› ï¼Œä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒ

#### 2. React Queryç¼“å­˜ç­–ç•¥é—®é¢˜ï¼ˆæ–°å‘ç°ï¼‰
**é—®é¢˜ä½ç½®**: `src/pages/course/hooks/useCourseData.ts:82-89`
```typescript
const CACHE_CONFIG = {
  courseDetails: {
    staleTime: 5 * 60 * 1000,    // 5åˆ†é’Ÿç¼“å­˜æ—¶é—´è¿‡é•¿
    gcTime: 30 * 60 * 1000,      
    retry: 1,                     
    retryDelay: 1000,            
    refetchOnWindowFocus: false, 
  }
}
```

**é—®é¢˜åˆ†æ**:
- 5åˆ†é’Ÿçš„staleTimeå¯¼è‡´è¯¾ç¨‹åˆ‡æ¢æ—¶ä½¿ç”¨æ—§çš„ç¼“å­˜æ•°æ®
- queryKeyè™½ç„¶åŒ…å«courseIdï¼Œä½†ç¼“å­˜å¤±æ•ˆæœºåˆ¶å¯èƒ½æœ‰é—®é¢˜
- refreshCourseDataçš„é”™è¯¯è°ƒç”¨å¯èƒ½å¹²æ‰°äº†æ­£å¸¸çš„ç¼“å­˜æ›´æ–°

#### 3. å¤šç»„ä»¶é‡å¤è°ƒç”¨ useCourseData
**é—®é¢˜ç»„ä»¶**:
- `src/pages/course/CoursePage.tsx:70` - ä¸»è¦è°ƒç”¨ï¼š`useCourseData(courseId)`
- `src/pages/course/components/LessonNavigation.tsx:24` - ä»…ä¸ºè·å– `refreshCourseData`
- `src/pages/course/components/LessonContent.tsx:70` - ä»…ä¸ºè·å– `refreshCourseData`
- å¯èƒ½è¿˜æœ‰å…¶ä»–ç»„ä»¶

**å½±å“**: åŒä¸€é¡µé¢å¤šä¸ªç»„ä»¶åŒæ—¶è§¦å‘ç›¸åŒçš„ React Queryï¼Œå¯¼è‡´å¹¶å‘è¯·æ±‚å†²çª

#### 4. Supabase å®¢æˆ·ç«¯ AbortController å†²çª
**ä½ç½®**: `src/integrations/supabase/client.ts:25-38`
```typescript
fetch: (url, options) => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  return fetch(url, {
    ...options,
    signal: controller.signal // â† ä¸ React Query çš„å†…ç½® AbortController å†²çª
  }).finally(() => clearTimeout(timeoutId));
}
```

**å½±å“**: è‡ªå®šä¹‰çš„ AbortController ä¸ React Query å†…ç½®çš„è¯·æ±‚å–æ¶ˆæœºåˆ¶å†²çª

#### 5. courseService Timer å†²çª
**ä½ç½®**: `src/services/courseService.ts:186-189, 219-223`
```typescript
console.time('getCourseDetails');  // â† å›ºå®šåç§°
console.time('getCourseBasicInfo'); // â† å›ºå®šåç§°
```

**å½±å“**: å¤šä¸ªå¹¶å‘è°ƒç”¨æ—¶ä½¿ç”¨ç›¸åŒçš„ Timer åç§°å¯¼è‡´å†²çª

## è§£å†³æ–¹æ¡ˆ

### ğŸš¨ é˜¶æ®µ 0: ç´§æ€¥ä¿®å¤è¯¾ç¨‹æ•°æ®æ··ä¹±é—®é¢˜ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

**ç›®æ ‡**: ç«‹å³ä¿®å¤ç‚¹å‡»èœœèœ‚è¯¾ç¨‹å´åŠ è½½ç‹—ç‹—è¯¾ç¨‹çš„é—®é¢˜

**ä¿®æ”¹æ–‡ä»¶**: `src/pages/course/CoursePage.tsx`

**å…·ä½“æ“ä½œ**:
1. **ç§»é™¤é”™è¯¯çš„refreshCourseDataè°ƒç”¨**
```typescript
// åˆ é™¤è¿™æ®µé”™è¯¯çš„ä»£ç 
useEffect(() => {
  if (lessonId) {
    refreshCourseData(); // â† åˆ é™¤è¿™è¡Œ
  }
}, [lessonId, refreshCourseData]);
```

2. **æ·»åŠ courseIdå˜åŒ–æ—¶çš„æ­£ç¡®å¤„ç†**
```typescript
// æ·»åŠ æ­£ç¡®çš„courseIdå˜åŒ–å¤„ç†
useEffect(() => {
  // åªæœ‰å½“courseIdå˜åŒ–æ—¶æ‰éœ€è¦åˆ·æ–°è¯¾ç¨‹æ•°æ®
  if (courseId) {
    // æ¸…é™¤å¯èƒ½çš„æ—§ç¼“å­˜ï¼Œç¡®ä¿è·å–æ­£ç¡®çš„è¯¾ç¨‹æ•°æ®
    queryClient.removeQueries({ queryKey: ['courseDetails'] });
    queryClient.removeQueries({ queryKey: ['enrollment'] });
  }
}, [courseId, queryClient]);
```

3. **ä¼˜åŒ–React Queryç¼“å­˜é…ç½®**
```typescript
const CACHE_CONFIG = {
  courseDetails: {
    staleTime: 30 * 1000,        // é™ä½åˆ°30ç§’ï¼Œç¡®ä¿æ•°æ®åŠæ—¶æ›´æ–°
    gcTime: 5 * 60 * 1000,       // é™ä½åˆ°5åˆ†é’Ÿ
    retry: 1,
    retryDelay: 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: true,        // ç¡®ä¿æŒ‚è½½æ—¶é‡æ–°è·å–
  },
  enrollment: {
    staleTime: 30 * 1000,        // é™ä½åˆ°30ç§’
    gcTime: 2 * 60 * 1000,       // é™ä½åˆ°2åˆ†é’Ÿ
    retry: 1,
    retryDelay: 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: true,        // ç¡®ä¿æŒ‚è½½æ—¶é‡æ–°è·å–
  }
};
```

### é˜¶æ®µ 1: ä¿®å¤ Supabase å®¢æˆ·ç«¯ AbortController å†²çª

**ç›®æ ‡**: ç§»é™¤è‡ªå®šä¹‰ fetch å‡½æ•°ä¸­çš„ AbortControllerï¼Œè®© React Query ç®¡ç†è¯·æ±‚å–æ¶ˆ

**ä¿®æ”¹æ–‡ä»¶**: `src/integrations/supabase/client.ts`

**å…·ä½“æ“ä½œ**:
1. ç§»é™¤è‡ªå®šä¹‰çš„ fetch å‡½æ•°ä¸­çš„ AbortController åˆ›å»º
2. ä¿ç•™è¶…æ—¶æœºåˆ¶ä½†ä½¿ç”¨å…¶ä»–æ–¹å¼å®ç°
3. è®© React Query çš„å†…ç½® AbortController æœºåˆ¶æ­£å¸¸å·¥ä½œ

```typescript
// ä¿®æ”¹å‰
fetch: (url, options) => {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 30000);
  
  return fetch(url, {
    ...options,
    signal: controller.signal
  }).finally(() => clearTimeout(timeoutId));
}

// ä¿®æ”¹å
fetch: (url, options) => {
  // å¦‚æœ React Query å·²ç»æä¾›äº† signalï¼Œç›´æ¥ä½¿ç”¨
  const timeoutId = options?.signal ? null : setTimeout(() => {
    // åªåœ¨æ²¡æœ‰å¤–éƒ¨ signal æ—¶åˆ›å»ºè¶…æ—¶
  }, 30000);
  
  return fetch(url, options).finally(() => {
    if (timeoutId) clearTimeout(timeoutId);
  });
}
```

### é˜¶æ®µ 2: ä¿®å¤ courseService Timer å†²çª

**ç›®æ ‡**: è§£å†³å¤šä¸ªå¹¶å‘è¯·æ±‚æ—¶çš„ console.time å†²çª

**ä¿®æ”¹æ–‡ä»¶**: `src/services/courseService.ts`

**å…·ä½“æ“ä½œ**:
1. ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆå”¯ä¸€çš„ Timer åç§°
2. ä½¿ç”¨æ—¶é—´æˆ³æˆ–éšæœºæ•°é¿å…å†²çª

```typescript
// ä¿®æ”¹å‰
console.time('getCourseDetails');

// ä¿®æ”¹å
const timerId = `getCourseDetails_${courseId}_${Date.now()}`;
console.time(timerId);
```

### é˜¶æ®µ 3: åˆ›å»º CourseDataProvider Context

**ç›®æ ‡**: ç»Ÿä¸€ç®¡ç†è¯¾ç¨‹æ•°æ®ï¼Œé¿å…é‡å¤è°ƒç”¨

**æ–°å»ºæ–‡ä»¶**: `src/contexts/CourseDataContext.tsx`

**åŠŸèƒ½è®¾è®¡**:
```typescript
interface CourseDataContextType {
  loading: boolean;
  courseData: (Course & { modules?: CourseModule[] }) | null;
  error: Error | null;
  progress: number;
  enrollmentId: string | null;
  enrollmentStatus: string | undefined;
  findCurrentLesson: (lessonId: string | undefined) => {
    selectedLesson: Lesson | null; 
    selectedUnit: CourseModule | null 
  };
  refreshCourseData: () => Promise<void>;
}
```

**ç»„ä»¶åŒ…è£…**:
- åœ¨ `CoursePage` æœ€é¡¶å±‚ä½¿ç”¨ `CourseDataProvider`
- å­ç»„ä»¶é€šè¿‡ `useCourseDataContext` è·å–æ•°æ®å’Œæ–¹æ³•

### é˜¶æ®µ 4: ä¼˜åŒ– React Query ç¼“å­˜é…ç½®

**ç›®æ ‡**: å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚

**ä¿®æ”¹æ–‡ä»¶**: `src/pages/course/hooks/useCourseData.ts`

**é…ç½®ä¼˜åŒ–**:
```typescript
const CACHE_CONFIG = {
  courseDetails: {
    staleTime: 10 * 60 * 1000,     // å¢åŠ åˆ° 10 åˆ†é’Ÿ
    gcTime: 60 * 60 * 1000,        // å¢åŠ åˆ° 1 å°æ—¶
    retry: 1,
    retryDelay: 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false,          // æ–°å¢ï¼šæŒ‚è½½æ—¶ä¸é‡æ–°è·å–
    refetchOnReconnect: false,      // æ–°å¢ï¼šé‡è¿æ—¶ä¸é‡æ–°è·å–
  },
  enrollment: {
    staleTime: 5 * 60 * 1000,      // å¢åŠ åˆ° 5 åˆ†é’Ÿ
    gcTime: 30 * 60 * 1000,        // å¢åŠ åˆ° 30 åˆ†é’Ÿ
    retry: 1,
    retryDelay: 1000,
    refetchOnWindowFocus: false,
    refetchOnMount: false,          // æ–°å¢
    refetchOnReconnect: false,      // æ–°å¢
  }
};
```

### é˜¶æ®µ 5: é‡æ„ç»„ä»¶è°ƒç”¨æ¶æ„

**ç›®æ ‡**: æ¶ˆé™¤é‡å¤çš„ useCourseData è°ƒç”¨

#### 5.1 ä¿®æ”¹ CoursePage.tsx
- ä¿ç•™ä¸»è¦çš„ `useCourseData` è°ƒç”¨
- ç”¨ `CourseDataProvider` åŒ…è£…æ•´ä¸ªé¡µé¢å†…å®¹
- ç§»é™¤ä¸å¿…è¦çš„ `refreshCourseData` è°ƒç”¨

#### 5.2 ä¿®æ”¹ LessonNavigation.tsx
- ç§»é™¤ `useCourseData` è°ƒç”¨
- ä½¿ç”¨ `useCourseDataContext` è·å– `refreshCourseData`

#### 5.3 ä¿®æ”¹ LessonContent.tsx
- ç§»é™¤ `useCourseData` è°ƒç”¨
- ä½¿ç”¨ `useCourseDataContext` è·å– `refreshCourseData`

#### 5.4 ç§»é™¤ä¸å¿…è¦çš„åˆ·æ–°è§¦å‘
- ç§»é™¤ CoursePage ä¸­ lessonId å˜åŒ–æ—¶çš„è‡ªåŠ¨åˆ·æ–°
- åªåœ¨çœŸæ­£éœ€è¦æ—¶ï¼ˆå¦‚å®Œæˆè¯¾ç¨‹ã€æäº¤ä½œä¸šï¼‰æ‰è°ƒç”¨ refreshCourseData

### é˜¶æ®µ 6: æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶

**ç›®æ ‡**: åœ¨ service å±‚é¢é˜²æ­¢é‡å¤è¯·æ±‚

**ä¿®æ”¹æ–‡ä»¶**: `src/services/courseService.ts`

**å®ç°æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ è¯·æ±‚å»é‡ Map
const pendingRequests = new Map<string, Promise<any>>();

async getCourseDetails(courseId: string) {
  const requestKey = `courseDetails_${courseId}`;
  
  // å¦‚æœå·²æœ‰ç›¸åŒè¯·æ±‚åœ¨è¿›è¡Œä¸­ï¼Œè¿”å›åŒä¸€ä¸ª Promise
  if (pendingRequests.has(requestKey)) {
    return pendingRequests.get(requestKey);
  }
  
  const requestPromise = this._getCourseDetailsImpl(courseId);
  pendingRequests.set(requestKey, requestPromise);
  
  try {
    const result = await requestPromise;
    return result;
  } finally {
    pendingRequests.delete(requestKey);
  }
}
```

## å®æ–½è®¡åˆ’

### ç¬¬ä¸€æ­¥: ç«‹å³ä¿®å¤ (ä¼˜å…ˆçº§: é«˜)
1. **ä¿®å¤ Supabase å®¢æˆ·ç«¯ AbortController å†²çª**
2. **ä¿®å¤ courseService Timer å†²çª**

### ç¬¬äºŒæ­¥: æ¶æ„ä¼˜åŒ– (ä¼˜å…ˆçº§: é«˜)
1. **åˆ›å»º CourseDataProvider Context**
2. **é‡æ„ CoursePage ä½¿ç”¨ Provider**

### ç¬¬ä¸‰æ­¥: ç»„ä»¶é‡æ„ (ä¼˜å…ˆçº§: ä¸­)
1. **ä¿®æ”¹ LessonNavigation ç»„ä»¶**
2. **ä¿®æ”¹ LessonContent ç»„ä»¶**
3. **ç§»é™¤ä¸å¿…è¦çš„åˆ·æ–°è°ƒç”¨**

### ç¬¬å››æ­¥: æ€§èƒ½ä¼˜åŒ– (ä¼˜å…ˆçº§: ä¸­)
1. **ä¼˜åŒ– React Query ç¼“å­˜é…ç½®**
2. **æ·»åŠ è¯·æ±‚å»é‡æœºåˆ¶**

### ç¬¬äº”æ­¥: æµ‹è¯•éªŒè¯ (ä¼˜å…ˆçº§: é«˜)
1. **éªŒè¯ AbortError å·²è§£å†³**
2. **ç¡®è®¤æ²¡æœ‰é‡å¤è¯·æ±‚**
3. **æ£€æŸ¥æ€§èƒ½æ”¹å–„æ•ˆæœ**
4. **æµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†**

## é¢„æœŸæ•ˆæœ

### é—®é¢˜è§£å†³
- âœ… æ¶ˆé™¤ AbortError: signal is aborted without reason
- âœ… æ¶ˆé™¤é‡å¤çš„ course_enrollments è¯·æ±‚
- âœ… æ¶ˆé™¤ Timer already exists è­¦å‘Š
- âœ… å¤§å¹…å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚

### æ€§èƒ½æå‡
- ğŸ“ˆ é¡µé¢åŠ è½½é€Ÿåº¦æå‡ 50-70%
- ğŸ“ˆ ç½‘ç»œè¯·æ±‚æ•°é‡å‡å°‘ 60-80%
- ğŸ“ˆ å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- ğŸ“ˆ ç”¨æˆ·ä½“éªŒæ”¹å–„

### ä»£ç è´¨é‡
- ğŸ”§ æ›´æ¸…æ™°çš„ç»„ä»¶æ¶æ„
- ğŸ”§ æ›´å¥½çš„æ•°æ®æµç®¡ç†
- ğŸ”§ æ›´å¼ºçš„é”™è¯¯å¤„ç†
- ğŸ”§ æ›´æ˜“ç»´æŠ¤çš„ä»£ç ç»“æ„

## é£é™©è¯„ä¼°

### ä½é£é™©
- Supabase å®¢æˆ·ç«¯ä¿®æ”¹ï¼ˆå‘åå…¼å®¹ï¼‰
- Timer åç§°ä¿®æ”¹ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

### ä¸­ç­‰é£é™©  
- Context æ¶æ„é‡æ„ï¼ˆéœ€è¦ä»”ç»†æµ‹è¯•ç»„ä»¶é—´æ•°æ®ä¼ é€’ï¼‰
- ç¼“å­˜é…ç½®ä¼˜åŒ–ï¼ˆå¯èƒ½å½±å“æ•°æ®å®æ—¶æ€§ï¼‰

### ç¼“è§£æªæ–½
- åˆ†é˜¶æ®µå®æ–½ï¼Œæ¯ä¸ªé˜¶æ®µç‹¬ç«‹æµ‹è¯•
- ä¿ç•™åŸæœ‰ä»£ç çš„å¤‡ä»½
- å……åˆ†çš„å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- åœ¨å¼€å‘ç¯å¢ƒå……åˆ†éªŒè¯åå†éƒ¨ç½²

---

**æœ€åæ›´æ–°æ—¶é—´**: 2024-01-15
**è´Ÿè´£äºº**: AI Assistant
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸
