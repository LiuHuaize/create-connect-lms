# 课程创建功能重构建议

## 当前问题分析

### 1. 自动保存机制问题
- 自动保存默认禁用，用户可能不知道需要手动启用
- 自动保存是通过检测变化来触发的，但`checkForChanges`可能不够精确，导致部分变更未被检测到
- 自动保存失败后的重试机制依赖于`setTimeout`，如果页面刷新或关闭，这个重试将丢失
- 缺乏本地存储备份，仅依赖服务器保存

### 2. 课程内容处理问题
- `handleSaveCourse`函数非常复杂，处理了课程、模块和课时的保存逻辑
- 删除逻辑被注释掉可能导致"幽灵"模块和课时存在于数据库中但未显示给用户
- 缺乏数据一致性保证，如果保存过程中出错，可能导致部分内容丢失

### 3. 错误处理和并发问题
- 在保存模块和课时时是批量进行的，但错误处理策略是"继续处理其他批次"，可能导致部分数据丢失而用户不自知
- 没有对保存操作的幂等性处理，这意味着如果用户快速多次点击保存，可能会导致重复保存或数据状态不一致
- 错误信息不够具体，用户难以理解问题所在

### 4. 状态管理和内存问题
- 历史记录功能存储了完整的课程和模块状态的副本，但没有对内容大小的限制，课程内容很大时可能导致内存问题
- 使用`JSON.parse(JSON.stringify())`进行深拷贝，这种方式在处理复杂对象时可能有性能问题
- 如果保存操作失败，前端状态可能与后端状态不一致

### 5. 用户体验和UI反馈问题
- 保存操作的UI反馈不完整，特别是在出错时
- 自动保存功能默认禁用，且没有明显提示用户需要手动开启
- 大型课程加载和保存时可能导致UI无响应

### 6. 代码结构和模块化问题
- `useCourseCreator.ts`文件过大，包含太多逻辑，违反了单一职责原则
- 缺乏模块化，功能耦合度高，难以测试和维护

### 7. 安全问题
- 前端直接使用supabase客户端进行数据库操作，而不是通过API层抽象
- 虽然使用了RLS(Row Level Security)，但直接在前端执行删除操作存在安全风险

## 重构建议

### 1. 模块化改进
- 将`useCourseCreator`拆分为更小的自定义钩子，每个钩子负责单一功能：
  - 创建`useCourseHistory`钩子专门处理历史记录
  - 创建`useCourseSave`钩子处理保存逻辑
  - 创建`useCourseAutoSave`钩子处理自动保存
- 分离UI组件和业务逻辑，提高可测试性

### 2. 后端逻辑加强
- 实现幂等的保存API，防止重复提交
- 恢复并改进删除逻辑，使用软删除方式处理删除的模块和课时
- 添加事务支持，确保批量操作的原子性
- 将数据库操作迁移到API层或Supabase函数中，避免直接从前端操作数据库
- 实现适当的后端验证，避免无效数据保存

### 3. 状态管理优化
- 限制历史记录的大小和复杂性，避免内存问题
- 使用更高效的深拷贝方法，如Immer库或结构化克隆算法
- 实现增量保存，而不是每次保存所有内容
- 改进`checkForChanges`函数，使其更加准确和高效
- 考虑使用状态管理库（如Redux或Zustand）来处理复杂状态

### 4. 错误处理和用户体验改进
- 添加更详细的错误信息和恢复机制
- 默认启用自动保存，并提供明确的视觉反馈
- 添加本地存储备份（如IndexedDB或localStorage），防止浏览器崩溃导致的数据丢失
- 实现表单校验，确保保存前数据有效
- 添加冲突检测和解决机制，避免多用户编辑冲突

### 5. 性能和可扩展性
- 实现分页加载大型课程内容
- 添加防抖机制，避免频繁调用保存API
- 引入不可变数据结构，简化状态更新逻辑
- 添加单元测试和集成测试，确保功能正确性
- 考虑实现乐观更新，提升感知性能

### 6. 数据一致性和安全性
- 实现软删除功能，避免数据丢失
- 添加版本控制机制，允许回滚到之前的版本
- 使用Supabase的RPC或Edge Functions替代直接数据库操作
- 实现适当的权限检查，确保只有授权用户才能修改课程

## 实施路线图

### 第一阶段：代码重构和模块化
1. 将现有代码按功能拆分成独立模块
2. 编写测试用例，确保功能正确性
3. 实现基本的错误处理和数据验证

### 第二阶段：后端逻辑增强
1. 实现事务支持和幂等API
2. 恢复并改进删除逻辑
3. 将关键数据库操作迁移到API层

### 第三阶段：用户体验和性能优化
1. 改进自动保存机制和错误反馈
2. 优化大型课程的加载和保存性能

### 第四阶段：高级功能和安全性
1. 实现版本控制和历史记录改进
2. 加强安全措施和权限控制
3. 实现多用户协作功能（如果需要）
