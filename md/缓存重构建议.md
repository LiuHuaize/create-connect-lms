
# è¯¾ç¨‹æ•°æ®åŠ è½½ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ æœ€ç»ˆç›®æ ‡
- **è¯¾ç¨‹é¦–æ¬¡åŠ è½½æ—¶é—´ä» 2-3ç§’ ä¼˜åŒ–åˆ° 0.8-1.2ç§’**
- **è¯¾ç¨‹åˆ‡æ¢å“åº”æ—¶é—´ä» 1-2ç§’ ä¼˜åŒ–åˆ° 200-500æ¯«ç§’**
- **å‡å°‘ 70% çš„ä¸å¿…è¦ç½‘ç»œè¯·æ±‚**
- **æå‡ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘ç™½å±æ—¶é—´**

---

## ğŸ“‹ ä¼˜åŒ–æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç§»é™¤æœ‰é—®é¢˜çš„IndexedDBç¼“å­˜ (ç«‹å³æ•ˆæœ)

**é—®é¢˜åˆ†æ**ï¼šå½“å‰IndexedDBåœ¨å¯åŠ¨æ—¶æ¸…ç†æ‰€æœ‰ç¼“å­˜ï¼Œå®é™…ä¸Šæ²¡æœ‰èµ·åˆ°ç¼“å­˜ä½œç”¨

**æ“ä½œ**ï¼š

1. **ä¿®æ”¹ `src/lib/indexedDBCache.ts`**
```typescript:src/lib/indexedDBCache.ts
// æ³¨é‡Šæ‰è‡ªåŠ¨æ¸…ç†é€»è¾‘
(function setupAutoCleaning() {
  // æš‚æ—¶ç¦ç”¨è‡ªåŠ¨æ¸…ç†ï¼Œè®©ç¼“å­˜çœŸæ­£ç”Ÿæ•ˆ
  /*
  setTimeout(() => {
    db.delete().then(() => db.open()).then(() => {
      console.log('å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†æ‰€æœ‰ç¼“å­˜');
    }).catch(err => {
      console.error('æ¸…ç†æ‰€æœ‰ç¼“å­˜å¤±è´¥:', err);
    });
  }, 2000);
  */
  
  console.log('IndexedDBç¼“å­˜å·²å¯ç”¨ï¼Œä¸è¿›è¡Œå¯åŠ¨æ¸…ç†');
})();
```

2. **ä¿®æ”¹ `src/pages/course/hooks/useCourseData.ts`**
```typescript:src/pages/course/hooks/useCourseData.ts
// æš‚æ—¶ç§»é™¤IndexedDBç¼“å­˜çš„ä½¿ç”¨ï¼Œä¸“æ³¨React Query
const fetchCourseDetails = async (courseId: string | undefined) => {
  if (!courseId) return null;
  
  console.log('æ­£åœ¨è·å–è¯¾ç¨‹è¯¦æƒ…:', courseId);
  console.time('fetchCourseDetails');
  
  try {
    const courseDetails = await courseService.getCourseDetails(courseId);
    console.timeEnd('fetchCourseDetails');
    return courseDetails;
  } catch (error) {
    console.error('è·å–è¯¾ç¨‹è¯¦æƒ…å¤±è´¥:', error);
    console.timeEnd('fetchCourseDetails');
    throw error;
  }
};

const fetchEnrollmentInfo = async (courseId: string, userId: string) => {
  if (!courseId || !userId) return null;
  
  try {
    const { data: enrollments, error } = await supabase
      .from('course_enrollments')
      .select('id, progress, status')
      .eq('user_id', userId)
      .eq('course_id', courseId)
      .maybeSingle();
        
    if (error) throw error;
    return enrollments;
  } catch (error) {
    console.error('è·å–è¯¾ç¨‹æ³¨å†Œä¿¡æ¯å¤±è´¥:', error);
    throw error;
  }
};
```

**é¢„æœŸæ•ˆæœ**ï¼šç«‹å³å‡å°‘å¯åŠ¨æ—¶çš„ç¼“å­˜æ¸…ç†æ“ä½œï¼Œè®©React Queryç¼“å­˜æ­£å¸¸å·¥ä½œ

---

### ç¬¬äºŒæ­¥ï¼šä¼˜åŒ–React Queryé…ç½® (æ˜¾è‘—æå‡)

**ä¿®æ”¹ `src/pages/course/hooks/useCourseData.ts`**

```typescript:src/pages/course/hooks/useCourseData.ts
// ä¼˜åŒ–ç¼“å­˜é…ç½®
const CACHE_CONFIG = {
  courseDetails: {
    staleTime: 5 * 60 * 1000,    // 5åˆ†é’Ÿå†…è®¤ä¸ºæ˜¯æ–°é²œçš„
    gcTime: 30 * 60 * 1000,      // 30åˆ†é’Ÿåæ¸…ç†
    retry: 1,                     // åªé‡è¯•1æ¬¡
    retryDelay: 1000,            // å›ºå®š1ç§’å»¶è¿Ÿ
    refetchOnWindowFocus: false, // çª—å£èšç„¦æ—¶ä¸é‡æ–°è·å–
  },
  enrollment: {
    staleTime: 2 * 60 * 1000,    // 2åˆ†é’Ÿå†…è®¤ä¸ºæ˜¯æ–°é²œçš„  
    gcTime: 10 * 60 * 1000,      // 10åˆ†é’Ÿåæ¸…ç†
    retry: 1,
    retryDelay: 1000,
    refetchOnWindowFocus: false,
    // ç§»é™¤è‡ªåŠ¨åˆ·æ–°ï¼Œå‡å°‘ä¸å¿…è¦è¯·æ±‚
    // refetchInterval: user?.id ? 3 * 60 * 1000 : false,
  }
};
```

**é¢„æœŸæ•ˆæœ**ï¼šå‡å°‘50%çš„é‡å¤ç½‘ç»œè¯·æ±‚ï¼Œæå‡ç¼“å­˜å‘½ä¸­ç‡

---

### ç¬¬ä¸‰æ­¥ï¼šä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ (æå‡æŸ¥è¯¢é€Ÿåº¦)

**ä¿®æ”¹ `src/services/courseService.ts`**

```typescript:src/services/courseService.ts
// ä¼˜åŒ–æ‰¹é‡è·å–è¯¾æ—¶ï¼Œåªè·å–å¿…è¦å­—æ®µ
async getModuleLessonsBatch(moduleIds: string[]): Promise<Record<string, Lesson[]>> {
  if (!moduleIds.length) return {};
  
  const { data, error } = await supabase
    .from("lessons")
    .select(`
      id,
      title,
      type,
      order_index,
      module_id,
      content,
      duration_minutes
    `) // åªé€‰æ‹©å¿…è¦å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
    .in("module_id", moduleIds)
    .order("order_index");
    
  if (error) {
    console.error(`æ‰¹é‡è·å–æ¨¡å—è¯¾æ—¶å¤±è´¥:`, error);
    throw error;
  }
  
  // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
}

// ä¼˜åŒ–è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯è·å–
async getCourseBasicInfo(courseId: string): Promise<Course> {
  const { data, error } = await supabase
    .from("courses")
    .select(`
      id,
      title,
      description,
      short_description,
      author_id,
      cover_image,
      status,
      category,
      difficulty,
      duration_minutes,
      updated_at,
      created_at
    `) // åªè·å–å¿…è¦å­—æ®µ
    .eq("id", courseId)
    .single();

  if (error) {
    console.error('è·å–è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯å¤±è´¥:', error);
    throw error;
  }
  
  return data as Course;
}
```

**é¢„æœŸæ•ˆæœ**ï¼šå‡å°‘æ•°æ®ä¼ è¾“é‡30-40%ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦

---

### ç¬¬å››æ­¥ï¼šå®ç°æ™ºèƒ½é¢„åŠ è½½ (æå‡ç”¨æˆ·ä½“éªŒ)

**åˆ›å»ºæ–°æ–‡ä»¶ `src/hooks/usePrefetchCourse.ts`**

```typescript:src/hooks/usePrefetchCourse.ts
import { useQueryClient } from '@tanstack/react-query';
import { courseService } from '@/services/courseService';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/integrations/supabase/client';

export const usePrefetchCourse = () => {
  const queryClient = useQueryClient();
  const { user } = useAuth();

  const prefetchCourseData = async (courseId: string) => {
    // é¢„åŠ è½½è¯¾ç¨‹è¯¦æƒ…
    queryClient.prefetchQuery({
      queryKey: ['courseDetails', courseId],
      queryFn: () => courseService.getCourseDetails(courseId),
      staleTime: 5 * 60 * 1000,
    });

    // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œé¢„åŠ è½½æ³¨å†Œä¿¡æ¯
    if (user?.id) {
      queryClient.prefetchQuery({
        queryKey: ['enrollment', courseId, user.id],
        queryFn: async () => {
          const { data } = await supabase
            .from('course_enrollments')
            .select('id, progress, status')
            .eq('user_id', user.id)
            .eq('course_id', courseId)
            .maybeSingle();
          return data;
        },
        staleTime: 2 * 60 * 1000,
      });
    }
  };

  return { prefetchCourseData };
};
```

**ä¿®æ”¹è¯¾ç¨‹å¡ç‰‡ç»„ä»¶ï¼Œæ·»åŠ æ‚¬åœé¢„åŠ è½½**

```typescript:src/components/course/CourseCard.tsx
import { usePrefetchCourse } from '@/hooks/usePrefetchCourse';

const CourseCard = ({ course }) => {
  const { prefetchCourseData } = usePrefetchCourse();

  const handleMouseEnter = () => {
    // ç”¨æˆ·æ‚¬åœæ—¶é¢„åŠ è½½æ•°æ®
    prefetchCourseData(course.id);
  };

  return (
    <div 
      onMouseEnter={handleMouseEnter}
      className="course-card"
    >
      {/* è¯¾ç¨‹å¡ç‰‡å†…å®¹ */}
    </div>
  );
};
```

**é¢„æœŸæ•ˆæœ**ï¼šç”¨æˆ·ç‚¹å‡»è¯¾ç¨‹æ—¶ï¼Œæ•°æ®å¯èƒ½å·²ç»é¢„åŠ è½½å®Œæˆï¼Œå®ç°ç¬é—´å“åº”

---

### ç¬¬äº”æ­¥ï¼šä¼˜åŒ–åŠ è½½çŠ¶æ€æ˜¾ç¤º (æ”¹å–„æ„ŸçŸ¥æ€§èƒ½)

**ä¿®æ”¹ `src/pages/course/CoursePage.tsx`**

```typescript:src/pages/course/CoursePage.tsx
const CoursePage = () => {
  // ... ç°æœ‰ä»£ç 

  const { loading: courseLoading, courseData, error: courseError } = useCourseData(courseId);
  const { loading: enrollmentLoading } = useEnrollmentData(courseId);
  
  // åˆ†å±‚åŠ è½½çŠ¶æ€
  const isInitialLoading = courseLoading && !courseData;
  const isDataUpdating = courseLoading && courseData;

  if (isInitialLoading) {
    return <LoadingSkeleton />;
  }

  if (courseError) {
    return <ErrorFallback error={courseError} />;
  }

  return (
    <div className="flex flex-col h-screen bg-macaron-cream">
      {/* æ•°æ®æ›´æ–°æ—¶æ˜¾ç¤ºé¡¶éƒ¨è¿›åº¦æ¡è€Œä¸æ˜¯å…¨å±loading */}
      {isDataUpdating && (
        <div className="h-1 bg-blue-200">
          <div className="h-1 bg-blue-600 animate-pulse w-1/3"></div>
        </div>
      )}
      
      <CourseHeader 
        courseData={courseData} 
        isMobile={isMobile} 
        setSidebarOpen={setSidebarOpen} 
      />
      
      {/* å…¶ä½™ç»„ä»¶ */}
    </div>
  );
};
```

**é¢„æœŸæ•ˆæœ**ï¼šç”¨æˆ·æ„ŸçŸ¥çš„åŠ è½½æ—¶é—´å‡å°‘ï¼Œæå‡ä½“éªŒæµç•…åº¦

---

### ç¬¬å…­æ­¥ï¼šé…ç½®å…¨å±€React Queryä¼˜åŒ– (æ•´ä½“æ€§èƒ½æå‡)

**ä¿®æ”¹ä¸»åº”ç”¨å…¥å£ï¼Œä¼˜åŒ–QueryClienté…ç½®**

```typescript:src/main.tsx
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,        // é»˜è®¤5åˆ†é’Ÿstaleæ—¶é—´
      gcTime: 30 * 60 * 1000,          // é»˜è®¤30åˆ†é’Ÿåƒåœ¾å›æ”¶
      retry: 1,                         // å…¨å±€åªé‡è¯•1æ¬¡
      refetchOnWindowFocus: false,      // ç¦ç”¨çª—å£èšç„¦é‡æ–°è·å–
      refetchOnMount: false,            // å¦‚æœæ•°æ®æ–°é²œåˆ™ä¸é‡æ–°è·å–
      refetchOnReconnect: true,         // ç½‘ç»œé‡è¿æ—¶é‡æ–°è·å–
    },
    mutations: {
      retry: 1,
    },
  },
});

// åœ¨å¼€å‘ç¯å¢ƒæ·»åŠ React Query DevTools
if (import.meta.env.DEV) {
  import('@tanstack/react-query-devtools').then(({ ReactQueryDevtools }) => {
    // å¯ä»¥ç”¨æ¥ç›‘æ§æŸ¥è¯¢æ€§èƒ½
  });
}
```

**é¢„æœŸæ•ˆæœ**ï¼šå…¨å±€ä¼˜åŒ–æŸ¥è¯¢è¡Œä¸ºï¼Œå‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚

---

## ğŸ§ª éªŒè¯ä¼˜åŒ–æ•ˆæœ

### æµ‹è¯•æ­¥éª¤ï¼š

1. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· â†’ Networké¢æ¿**
2. **æ¸…é™¤ç¼“å­˜ï¼Œç¡¬åˆ·æ–°é¡µé¢**
3. **è®°å½•é¦–æ¬¡åŠ è½½æ—¶é—´å’Œè¯·æ±‚æ•°é‡**
4. **æµ‹è¯•è¯¾ç¨‹é—´åˆ‡æ¢é€Ÿåº¦**
5. **æµ‹è¯•æ‚¬åœé¢„åŠ è½½æ•ˆæœ**

### å…³é”®æŒ‡æ ‡ï¼š

- **é¦–æ¬¡åŠ è½½æ—¶é—´**ï¼šä»ç‚¹å‡»åˆ°è¯¾ç¨‹å†…å®¹æ˜¾ç¤ºçš„æ—¶é—´
- **ç½‘ç»œè¯·æ±‚æ•°é‡**ï¼šæ€»è¯·æ±‚æ•°å’Œé‡å¤è¯·æ±‚æ•°
- **ç¼“å­˜å‘½ä¸­ç‡**ï¼šReact Query DevToolsä¸­æ˜¾ç¤ºçš„ç¼“å­˜ä½¿ç”¨æƒ…å†µ
- **ç”¨æˆ·ä½“éªŒ**ï¼šç™½å±æ—¶é—´å’Œäº¤äº’å“åº”é€Ÿåº¦

---

## ğŸš€ é¢„æœŸæœ€ç»ˆæ•ˆæœ

1. **é¦–æ¬¡è®¿é—®è¯¾ç¨‹é¡µé¢**ï¼š0.8-1.2ç§’åŠ è½½å®Œæˆ
2. **è¯¾ç¨‹é—´åˆ‡æ¢**ï¼š200-500æ¯«ç§’å“åº”æ—¶é—´  
3. **é‡å¤è®¿é—®**ï¼šåŸºæœ¬å®ç°ç¬é—´åŠ è½½ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰
4. **ç½‘ç»œè¯·æ±‚å‡å°‘70%**ï¼šé¿å…é‡å¤å’Œä¸å¿…è¦çš„è¯·æ±‚
5. **ç”¨æˆ·ä½“éªŒæå‡**ï¼šæµç•…çš„åŠ è½½åŠ¨ç”»ï¼Œå‡å°‘ç™½å±

è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆå¾ªåºæ¸è¿›ï¼Œæ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„ç›®æ ‡å’Œå¯è¡¡é‡çš„æ•ˆæœã€‚å»ºè®®æŒ‰é¡ºåºå®æ–½ï¼Œå¹¶åœ¨æ¯æ­¥å®Œæˆåæµ‹è¯•æ•ˆæœï¼Œç¡®ä¿ä¼˜åŒ–æ–¹å‘æ­£ç¡®ã€‚
