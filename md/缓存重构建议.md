
# 课程数据加载优化方案

## 🎯 最终目标
- **课程首次加载时间从 2-3秒 优化到 0.8-1.2秒**
- **课程切换响应时间从 1-2秒 优化到 200-500毫秒**
- **减少 70% 的不必要网络请求**
- **提升用户体验，减少白屏时间**

---

## 📋 优化步骤

### 第一步：移除有问题的IndexedDB缓存 (立即效果)

**问题分析**：当前IndexedDB在启动时清理所有缓存，实际上没有起到缓存作用

**操作**：

1. **修改 `src/lib/indexedDBCache.ts`**
```typescript:src/lib/indexedDBCache.ts
// 注释掉自动清理逻辑
(function setupAutoCleaning() {
  // 暂时禁用自动清理，让缓存真正生效
  /*
  setTimeout(() => {
    db.delete().then(() => db.open()).then(() => {
      console.log('启动时自动清理所有缓存');
    }).catch(err => {
      console.error('清理所有缓存失败:', err);
    });
  }, 2000);
  */
  
  console.log('IndexedDB缓存已启用，不进行启动清理');
})();
```

2. **修改 `src/pages/course/hooks/useCourseData.ts`**
```typescript:src/pages/course/hooks/useCourseData.ts
// 暂时移除IndexedDB缓存的使用，专注React Query
const fetchCourseDetails = async (courseId: string | undefined) => {
  if (!courseId) return null;
  
  console.log('正在获取课程详情:', courseId);
  console.time('fetchCourseDetails');
  
  try {
    const courseDetails = await courseService.getCourseDetails(courseId);
    console.timeEnd('fetchCourseDetails');
    return courseDetails;
  } catch (error) {
    console.error('获取课程详情失败:', error);
    console.timeEnd('fetchCourseDetails');
    throw error;
  }
};

const fetchEnrollmentInfo = async (courseId: string, userId: string) => {
  if (!courseId || !userId) return null;
  
  try {
    const { data: enrollments, error } = await supabase
      .from('course_enrollments')
      .select('id, progress, status')
      .eq('user_id', userId)
      .eq('course_id', courseId)
      .maybeSingle();
        
    if (error) throw error;
    return enrollments;
  } catch (error) {
    console.error('获取课程注册信息失败:', error);
    throw error;
  }
};
```

**预期效果**：立即减少启动时的缓存清理操作，让React Query缓存正常工作

---

### 第二步：优化React Query配置 (显著提升)

**修改 `src/pages/course/hooks/useCourseData.ts`**

```typescript:src/pages/course/hooks/useCourseData.ts
// 优化缓存配置
const CACHE_CONFIG = {
  courseDetails: {
    staleTime: 5 * 60 * 1000,    // 5分钟内认为是新鲜的
    gcTime: 30 * 60 * 1000,      // 30分钟后清理
    retry: 1,                     // 只重试1次
    retryDelay: 1000,            // 固定1秒延迟
    refetchOnWindowFocus: false, // 窗口聚焦时不重新获取
  },
  enrollment: {
    staleTime: 2 * 60 * 1000,    // 2分钟内认为是新鲜的  
    gcTime: 10 * 60 * 1000,      // 10分钟后清理
    retry: 1,
    retryDelay: 1000,
    refetchOnWindowFocus: false,
    // 移除自动刷新，减少不必要请求
    // refetchInterval: user?.id ? 3 * 60 * 1000 : false,
  }
};
```

**预期效果**：减少50%的重复网络请求，提升缓存命中率

---

### 第三步：优化数据库查询性能 (提升查询速度)

**修改 `src/services/courseService.ts`**

```typescript:src/services/courseService.ts
// 优化批量获取课时，只获取必要字段
async getModuleLessonsBatch(moduleIds: string[]): Promise<Record<string, Lesson[]>> {
  if (!moduleIds.length) return {};
  
  const { data, error } = await supabase
    .from("lessons")
    .select(`
      id,
      title,
      type,
      order_index,
      module_id,
      content,
      duration_minutes
    `) // 只选择必要字段，减少数据传输
    .in("module_id", moduleIds)
    .order("order_index");
    
  if (error) {
    console.error(`批量获取模块课时失败:`, error);
    throw error;
  }
  
  // ... 其余代码保持不变
}

// 优化课程基本信息获取
async getCourseBasicInfo(courseId: string): Promise<Course> {
  const { data, error } = await supabase
    .from("courses")
    .select(`
      id,
      title,
      description,
      short_description,
      author_id,
      cover_image,
      status,
      category,
      difficulty,
      duration_minutes,
      updated_at,
      created_at
    `) // 只获取必要字段
    .eq("id", courseId)
    .single();

  if (error) {
    console.error('获取课程基本信息失败:', error);
    throw error;
  }
  
  return data as Course;
}
```

**预期效果**：减少数据传输量30-40%，提升查询速度

---

### 第四步：实现智能预加载 (提升用户体验)

**创建新文件 `src/hooks/usePrefetchCourse.ts`**

```typescript:src/hooks/usePrefetchCourse.ts
import { useQueryClient } from '@tanstack/react-query';
import { courseService } from '@/services/courseService';
import { useAuth } from '@/contexts/AuthContext';
import { supabase } from '@/integrations/supabase/client';

export const usePrefetchCourse = () => {
  const queryClient = useQueryClient();
  const { user } = useAuth();

  const prefetchCourseData = async (courseId: string) => {
    // 预加载课程详情
    queryClient.prefetchQuery({
      queryKey: ['courseDetails', courseId],
      queryFn: () => courseService.getCourseDetails(courseId),
      staleTime: 5 * 60 * 1000,
    });

    // 如果用户已登录，预加载注册信息
    if (user?.id) {
      queryClient.prefetchQuery({
        queryKey: ['enrollment', courseId, user.id],
        queryFn: async () => {
          const { data } = await supabase
            .from('course_enrollments')
            .select('id, progress, status')
            .eq('user_id', user.id)
            .eq('course_id', courseId)
            .maybeSingle();
          return data;
        },
        staleTime: 2 * 60 * 1000,
      });
    }
  };

  return { prefetchCourseData };
};
```

**修改课程卡片组件，添加悬停预加载**

```typescript:src/components/course/CourseCard.tsx
import { usePrefetchCourse } from '@/hooks/usePrefetchCourse';

const CourseCard = ({ course }) => {
  const { prefetchCourseData } = usePrefetchCourse();

  const handleMouseEnter = () => {
    // 用户悬停时预加载数据
    prefetchCourseData(course.id);
  };

  return (
    <div 
      onMouseEnter={handleMouseEnter}
      className="course-card"
    >
      {/* 课程卡片内容 */}
    </div>
  );
};
```

**预期效果**：用户点击课程时，数据可能已经预加载完成，实现瞬间响应

---

### 第五步：优化加载状态显示 (改善感知性能)

**修改 `src/pages/course/CoursePage.tsx`**

```typescript:src/pages/course/CoursePage.tsx
const CoursePage = () => {
  // ... 现有代码

  const { loading: courseLoading, courseData, error: courseError } = useCourseData(courseId);
  const { loading: enrollmentLoading } = useEnrollmentData(courseId);
  
  // 分层加载状态
  const isInitialLoading = courseLoading && !courseData;
  const isDataUpdating = courseLoading && courseData;

  if (isInitialLoading) {
    return <LoadingSkeleton />;
  }

  if (courseError) {
    return <ErrorFallback error={courseError} />;
  }

  return (
    <div className="flex flex-col h-screen bg-macaron-cream">
      {/* 数据更新时显示顶部进度条而不是全屏loading */}
      {isDataUpdating && (
        <div className="h-1 bg-blue-200">
          <div className="h-1 bg-blue-600 animate-pulse w-1/3"></div>
        </div>
      )}
      
      <CourseHeader 
        courseData={courseData} 
        isMobile={isMobile} 
        setSidebarOpen={setSidebarOpen} 
      />
      
      {/* 其余组件 */}
    </div>
  );
};
```

**预期效果**：用户感知的加载时间减少，提升体验流畅度

---

### 第六步：配置全局React Query优化 (整体性能提升)

**修改主应用入口，优化QueryClient配置**

```typescript:src/main.tsx
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,        // 默认5分钟stale时间
      gcTime: 30 * 60 * 1000,          // 默认30分钟垃圾回收
      retry: 1,                         // 全局只重试1次
      refetchOnWindowFocus: false,      // 禁用窗口聚焦重新获取
      refetchOnMount: false,            // 如果数据新鲜则不重新获取
      refetchOnReconnect: true,         // 网络重连时重新获取
    },
    mutations: {
      retry: 1,
    },
  },
});

// 在开发环境添加React Query DevTools
if (import.meta.env.DEV) {
  import('@tanstack/react-query-devtools').then(({ ReactQueryDevtools }) => {
    // 可以用来监控查询性能
  });
}
```

**预期效果**：全局优化查询行为，减少不必要的网络请求

---

## 🧪 验证优化效果

### 测试步骤：

1. **打开浏览器开发者工具 → Network面板**
2. **清除缓存，硬刷新页面**
3. **记录首次加载时间和请求数量**
4. **测试课程间切换速度**
5. **测试悬停预加载效果**

### 关键指标：

- **首次加载时间**：从点击到课程内容显示的时间
- **网络请求数量**：总请求数和重复请求数
- **缓存命中率**：React Query DevTools中显示的缓存使用情况
- **用户体验**：白屏时间和交互响应速度

---

## 🚀 预期最终效果

1. **首次访问课程页面**：0.8-1.2秒加载完成
2. **课程间切换**：200-500毫秒响应时间  
3. **重复访问**：基本实现瞬间加载（缓存命中）
4. **网络请求减少70%**：避免重复和不必要的请求
5. **用户体验提升**：流畅的加载动画，减少白屏

这个优化方案循序渐进，每一步都有明确的目标和可衡量的效果。建议按顺序实施，并在每步完成后测试效果，确保优化方向正确。
