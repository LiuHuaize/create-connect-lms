# 课程保存逻辑优化重构方案

## 🎯 优化目标
- 移除复杂的自动保存逻辑，简化为手动保存
- 减少不必要的状态管理，降低内存占用
- 统一保存逻辑，避免代码重复
- 提升保存性能，避免out of memory问题

## 📊 当前问题分析

### 主要问题
1. **状态过多**：15+ 个保存相关状态
2. **逻辑复杂**：自动保存、历史记录、变更检测等
3. **内存泄漏**：深拷贝、频繁useEffect、ref滥用
4. **代码重复**：多个保存入口，逻辑分散

### 影响
- 频繁触发重新渲染
- 内存占用过高导致崩溃
- 保存逻辑难以调试和维护

---

## 🔄 重构步骤

### **第一步：移除自动保存相关代码**

#### 🎯 目标
完全移除自动保存功能，简化状态管理

#### 📋 待删除的状态
```typescript
// 在 useCourseCreator.ts 中删除
const [isAutoSaving, setIsAutoSaving] = useState(false);
const [lastSaved, setLastSaved] = useState<Date | null>(null);
const [autoSaveEnabled, setAutoSaveEnabled] = useState(false);
const autoSaveTimeoutRef = useRef<NodeJS.Timeout | null>(null);
const previousCourseRef = useRef<Course | null>(null);
const previousModulesRef = useRef<CourseModule[] | null>(null);
```

#### 📋 待删除的函数
```typescript
// 删除这些复杂的自动保存函数
const handleAutoSave = async () => { /* 复杂逻辑 */ };
const checkForChanges = () => { /* 深度对比逻辑 */ };
```

#### 📋 待删除的useEffect
```typescript
// 删除自动保存监听器
useEffect(() => {
  if (!autoSaveEnabled) return;
  if (isLoading || !moduleDataLoaded) return;
  // ... 复杂的变更检测逻辑
}, [course, modules, autoSaveEnabled]);
```

#### ✅ 检测方法
1. 搜索所有包含 `autoSave`、`Auto`、`previousRef` 的代码
2. 运行 `npm run build` 确保没有编译错误
3. 测试保存按钮是否正常工作

#### 🧪 测试步骤
1. 创建新课程，点击保存按钮
2. 编辑现有课程，点击保存按钮
3. 确认没有自动保存相关的toast提示

---

### **第二步：简化课程创建器Hook**

#### 🎯 目标
将 `useCourseCreator` 从 894 行精简至约 200 行

#### 📋 保留的核心状态
```typescript
// 只保留这些必要状态
const [course, setCourse] = useState<Course>({...});
const [modules, setModules] = useState<CourseModule[]>([]);
const [currentLesson, setCurrentLesson] = useState<Lesson | null>(null);
const [expandedModule, setExpandedModule] = useState<string | null>(null);
const [isLoading, setIsLoading] = useState(false);
const [isSaving, setIsSaving] = useState(false);
```

#### 📋 移除的复杂功能
- 历史记录（撤销/重做）
- 变更检测
- 自动保存状态同步
- 复杂的内存优化

#### ✅ 检测方法
1. 统计Hook代码行数：`wc -l useCourseCreator.ts`
2. 检查状态数量，确保 ≤ 6 个
3. 验证基本功能：加载、编辑、保存

#### 🧪 测试步骤
1. 加载课程：URL带 `?id=xxx` 参数
2. 编辑课程：修改标题、描述
3. 添加模块和课时
4. 保存功能正常

---

### **第三步：创建统一的保存Service**

#### 🎯 目标
将分散的保存逻辑统一到一个简单的service中

#### 📁 创建新文件：`src/services/simpleCourseService.ts`
```typescript
interface SaveCourseRequest {
  course: Course;
  modules: CourseModule[];
}

class SimpleCourseService {
  async saveCourse(request: SaveCourseRequest): Promise<Course> {
    // 1. 保存课程基本信息
    // 2. 保存模块
    // 3. 保存课时
    // 简单直接，无复杂优化
  }
}
```

#### 📋 移除的复杂逻辑
- 批量处理逻辑
- 内存优化代码
- 幂等性处理
- 变更检测

#### ✅ 检测方法
1. 新service文件 < 100 行代码
2. 只有一个公共方法 `saveCourse`
3. 无复杂的错误处理和重试逻辑

#### 🧪 测试步骤
1. 保存空课程（只有标题）
2. 保存带模块的课程
3. 保存完整课程（模块+课时）
4. 检查数据库数据正确性

---

### **第四步：简化保存Hook**

#### 🎯 目标
将 `useCourseSave` 从 275 行简化至约 50 行

#### 📋 简化后的Hook结构
```typescript
export const useSimpleCourseSave = (course: Course, modules: CourseModule[]) => {
  const [isSaving, setIsSaving] = useState(false);
  
  const saveCourse = async () => {
    // 简单的保存逻辑，无复杂优化
  };
  
  return { isSaving, saveCourse };
};
```

#### 📋 移除的功能
- 大型内容检测
- 批量处理
- 内存管理
- 复杂错误处理

#### ✅ 检测方法
1. Hook代码 < 50 行
2. 只返回 2 个值：`isSaving`, `saveCourse`
3. 无复杂的依赖注入

#### 🧪 测试步骤
1. 保存按钮显示正确状态
2. 保存期间按钮禁用
3. 保存成功后toast提示
4. 保存失败后错误提示

---

### **第五步：清理相关文件**

#### 🎯 目标
删除不必要的文件和代码

#### 📋 可以删除的文件
```bash
src/hooks/useCourseAutoSave.ts      # 自动保存Hook
src/hooks/useCourseHistory.ts       # 历史记录Hook（如果存在）
src/hooks/useLocalBackup.ts         # 本地备份Hook
src/utils/memoryUtils.ts            # 内存优化工具
```

#### 📋 可以简化的文件
```bash
src/stores/courseStore.ts           # 移除自动保存状态
src/components/course/creator/CourseHeader.tsx  # 移除自动保存UI
```

#### ✅ 检测方法
1. 搜索删除文件的引用，确保无遗留
2. 运行 `npm run build` 无错误
3. Bundle大小减少

#### 🧪 测试步骤
1. 完整的课程创建流程
2. 课程编辑流程
3. 保存功能正常
4. 页面无控制台错误

---

### **第六步：优化查询策略**

#### 🎯 目标
减少不必要的API请求和状态刷新

#### 📋 React Query配置优化
```typescript
const queryConfig = {
  staleTime: 5 * 60 * 1000,      // 5分钟内不重复请求
  refetchOnWindowFocus: false,   // 禁用窗口聚焦刷新
  refetchOnMount: false,         // 禁用挂载时刷新
  retry: 1,                      // 减少重试次数
}
```

#### 📋 移除过度刷新
- 移除 `refreshCourseData()` 的频繁调用
- 减少 `invalidateQueries()` 使用
- 简化缓存策略

#### ✅ 检测方法
1. 打开Network面板，监控API请求
2. 切换页面时请求数量 < 3个
3. 窗口聚焦时无额外请求

#### 🧪 测试步骤
1. 页面切换测试
2. 窗口聚焦/失焦测试
3. 数据更新及时性测试
4. 性能监控（内存使用）

---

## 📈 预期效果

### 性能提升
- **内存使用**：减少 60-70%
- **代码量**：减少 50% 以上
- **状态数量**：从 15+ 减少至 6 个
- **API请求**：减少 40-50%

### 维护性提升
- **调试难度**：大幅降低
- **bug定位**：更容易
- **新功能添加**：更简单
- **代码理解**：更直观

### 用户体验
- **页面响应**：更快
- **崩溃率**：大幅降低
- **保存反馈**：更明确
- **操作流畅性**：显著提升

---

## ⚠️ 注意事项

### 数据安全
1. 重构过程中定期备份数据库
2. 在开发环境充分测试
3. 保留回退方案

### 功能保证
1. 核心保存功能不能破坏
2. 用户数据不能丢失
3. 保存状态反馈要准确

### 渐进式重构
1. 一次只执行一个步骤
2. 每步完成后进行测试
3. 确认无问题再进行下一步

---

## 🔍 验证清单

### 功能验证
- [ ] 创建新课程
- [ ] 编辑现有课程
- [ ] 添加/删除模块
- [ ] 添加/删除课时
- [ ] 保存成功反馈
- [ ] 保存失败处理

### 性能验证
- [ ] 内存使用监控
- [ ] API请求数量
- [ ] 页面响应速度
- [ ] 无内存泄漏

### 代码质量
- [ ] 代码行数减少
- [ ] 状态复杂度降低
- [ ] 无控制台错误
- [ ] TypeScript编译通过

通过以上步骤的系统性重构，可以将复杂的保存逻辑简化为清晰、高效、易维护的代码结构。
