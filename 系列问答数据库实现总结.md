# 系列问答功能数据库实现总结

## 概述
本文档总结了系列问答功能的数据库层实现，包括表结构、函数、视图和安全策略。

## 已创建的数据库对象

### 1. 核心数据表

#### `series_questionnaires` - 系列问答主表
```sql
- id (uuid, 主键)
- title (text, 问卷标题)
- description (text, 问卷描述)
- instructions (text, 答题说明)
- lesson_id (uuid, 关联课时)
- ai_grading_prompt (text, AI评分提示)
- ai_grading_criteria (text, 评分标准)
- max_score (integer, 最高分数, 默认100)
- time_limit_minutes (integer, 时间限制)
- allow_save_draft (boolean, 允许保存草稿, 默认true)
- skill_tags (text[], 技能标签)
- created_at, updated_at (timestamp)
```

#### `series_questions` - 问题表
```sql
- id (uuid, 主键)
- questionnaire_id (uuid, 关联问卷)
- title (text, 问题标题)
- description (text, 问题描述)
- question_text (text, 问题内容)
- order_index (integer, 排序)
- required (boolean, 是否必答, 默认true)
- min_words (integer, 最少字数, 默认0)
- max_words (integer, 最多字数)
- placeholder_text (text, 占位符文本)
- created_at, updated_at (timestamp)
```

#### `series_submissions` - 学生提交表
```sql
- id (uuid, 主键)
- questionnaire_id (uuid, 关联问卷)
- student_id (uuid, 学生ID)
- status (text, 状态: draft/submitted/graded, 默认draft)
- answers (jsonb, 答案内容)
- total_words (integer, 总字数, 默认0)
- time_spent_minutes (integer, 用时, 默认0)
- submitted_at (timestamp, 提交时间)
- created_at, updated_at (timestamp)
```

#### `series_ai_gradings` - AI评分表
```sql
- id (uuid, 主键)
- submission_id (uuid, 关联提交)
- ai_score (integer, AI评分)
- ai_feedback (text, AI反馈)
- ai_detailed_feedback (jsonb, 详细反馈)
- teacher_score (integer, 教师评分)
- teacher_feedback (text, 教师反馈)
- final_score (integer, 最终分数)
- grading_criteria_used (text, 使用的评分标准)
- graded_at (timestamp, 评分时间, 默认now())
- teacher_reviewed_at (timestamp, 教师审核时间)
- created_at, updated_at (timestamp)
```

### 2. 索引优化
```sql
-- 性能优化索引
CREATE INDEX idx_series_questions_questionnaire_order ON series_questions(questionnaire_id, order_index);
CREATE INDEX idx_series_submissions_student_questionnaire ON series_submissions(student_id, questionnaire_id);
CREATE INDEX idx_series_submissions_status ON series_submissions(status);
CREATE INDEX idx_series_ai_gradings_submission ON series_ai_gradings(submission_id);
```

### 3. 约束条件
```sql
-- 唯一约束：每个学生每个问卷只能有一个提交
ALTER TABLE series_submissions ADD CONSTRAINT unique_student_questionnaire 
UNIQUE (student_id, questionnaire_id);

-- 外键约束
ALTER TABLE series_questions ADD CONSTRAINT fk_series_questions_questionnaire 
FOREIGN KEY (questionnaire_id) REFERENCES series_questionnaires(id) ON DELETE CASCADE;

ALTER TABLE series_submissions ADD CONSTRAINT fk_series_submissions_questionnaire 
FOREIGN KEY (questionnaire_id) REFERENCES series_questionnaires(id) ON DELETE CASCADE;

ALTER TABLE series_ai_gradings ADD CONSTRAINT fk_series_ai_gradings_submission 
FOREIGN KEY (submission_id) REFERENCES series_submissions(id) ON DELETE CASCADE;
```

### 4. 辅助函数

#### `get_series_questionnaire_details(uuid)`
获取问卷完整信息，包括所有问题
```sql
SELECT public.get_series_questionnaire_details('问卷ID');
```

#### `get_student_submission_status(uuid, uuid)`
获取学生的提交状态和评分信息
```sql
SELECT public.get_student_submission_status('问卷ID', '学生ID');
```

#### `calculate_submission_word_count(jsonb)`
计算提交答案的总字数
```sql
SELECT public.calculate_submission_word_count('{"q1": "答案内容"}');
```

### 5. 统计视图

#### `series_questionnaire_stats`
问卷统计信息视图
```sql
SELECT * FROM public.series_questionnaire_stats;
-- 返回：问卷ID、标题、提交数、已评分数、平均分、平均字数、平均用时等
```

### 6. 触发器

#### 自动更新时间戳
所有表都有 `updated_at` 字段的自动更新触发器

#### 自动计算字数
`series_submissions` 表在插入/更新时自动计算 `total_words` 字段

### 7. 行级安全策略 (RLS)

#### 系列问答主表
- 所有认证用户可读取
- 教师可管理自己课程的问卷

#### 问题表
- 所有认证用户可读取
- 教师可管理自己课程的问题

#### 提交表
- 学生只能查看自己的提交
- 教师可查看自己课程的所有提交
- 学生可创建和更新自己的提交

#### 评分表
- 学生可查看自己的评分
- 教师可管理自己课程的评分
- 系统可创建AI评分记录

## 测试验证

### 测试数据
已创建测试问卷 "狗狗知识反思问答"，包含4个测试问题：
1. 狗狗品种认知 (必答，50-300字)
2. 狗狗护理知识 (必答，30-200字)
3. 人狗关系思考 (必答，40-250字)
4. 创新思维 (选答，20-200字)

### 验证结果
- ✅ 所有表创建成功
- ✅ 外键关系正确
- ✅ RLS策略生效
- ✅ 函数和视图正常工作
- ✅ 触发器自动执行
- ✅ 索引优化到位

## 下一步工作
1. 创建 TypeScript 类型定义
2. 实现前端服务层
3. 开发用户界面组件
4. 集成AI评分功能
5. 添加游戏化集成

## 技术要点
- 使用 JSONB 存储灵活的答案数据
- 通过 RLS 确保数据安全
- 优化索引提升查询性能
- 触发器自动维护数据一致性
- 函数封装复杂查询逻辑
- 视图提供统计分析能力
