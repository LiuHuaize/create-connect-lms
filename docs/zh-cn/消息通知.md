
## 通知系统设计规划 (Notification System Design)

### 概述
建立一个完整的实时通知系统，用于师生之间的作业提交、评分通知等场景。

### 数据库设计

#### notifications 表结构
```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN (
    'student_submitted_series',
    'student_submitted_assignment', 
    'teacher_graded_series',
    'teacher_graded_assignment',
    'course_announcement',
    'system_notification'
  )),
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  
  -- 关联实体信息
  related_entity_type TEXT CHECK (related_entity_type IN ('course', 'lesson', 'submission', 'assignment')),
  related_entity_id UUID,
  
  -- 额外的元数据（如跳转链接）
  metadata JSONB DEFAULT '{}',
  
  -- 状态信息
  is_read BOOLEAN DEFAULT FALSE,
  read_at TIMESTAMP WITH TIME ZONE,
  
  -- 优化字段
  priority INTEGER DEFAULT 1 CHECK (priority BETWEEN 1 AND 5),
  expires_at TIMESTAMP WITH TIME ZONE,
  
  -- 时间戳
  created_at TIMESTAMP WITH TIME ZONE DEFAULT now(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

-- 性能优化索引
CREATE INDEX idx_notifications_user_id_read ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
CREATE INDEX idx_notifications_type ON notifications(type);
```

#### RLS 安全策略
```sql
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

CREATE POLICY "用户只能查看自己的通知" ON notifications
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "用户只能更新自己的通知" ON notifications  
  FOR UPDATE USING (auth.uid() = user_id);
```

### 服务层设计

#### NotificationService 核心功能
- `createNotification(notification: CreateNotificationData): Promise<Notification>`
- `getNotifications(userId: string, options?: GetNotificationsOptions): Promise<Notification[]>`
- `getUnreadCount(userId: string): Promise<number>`
- `markAsRead(notificationId: string): Promise<void>`
- `markAllAsRead(userId: string): Promise<void>`
- `deleteNotification(notificationId: string): Promise<void>`

#### 通知触发集成点
1. **系列问答提交**：在 `seriesQuestionnaireService.ts` 中集成
   - 学生提交 → 通知课程作者（老师）
   - 老师评分 → 通知提交学生

2. **作业提交**：在 `assignmentService.ts` 中集成
   - 学生提交作业 → 通知相关老师
   - 老师批改完成 → 通知学生

3. **权限识别逻辑**：
   - 通过 `courses.author_id` 识别课程负责老师
   - 通过 `course_enrollments` 识别相关学生

### 前端组件设计

#### 核心UI组件
1. **NotificationBell**: 右上角铃铛图标
   - 显示未读通知数量红点
   - 点击展开通知下拉菜单

2. **NotificationDropdown**: 通知下拉列表
   - 最近通知预览（5-10条）
   - "查看全部"和"全部标记为已读"按钮

3. **NotificationList**: 完整通知列表页面
   - 分页显示所有通知
   - 筛选和排序功能

4. **NotificationItem**: 单个通知项
   - 标题、内容、时间显示
   - 已读/未读状态区分
   - 点击跳转到相关页面

#### 状态管理
- 使用 Zustand store 管理通知状态
- 实现未读数量的全局状态同步
- 支持实时通知更新（轮询机制）

### 通知类型定义

#### TypeScript 类型
```typescript
export interface Notification {
  id: string;
  user_id: string;
  type: NotificationType;
  title: string;
  message: string;
  related_entity_type?: 'course' | 'lesson' | 'submission' | 'assignment';
  related_entity_id?: string;
  metadata: Record<string, any>;
  is_read: boolean;
  read_at?: string;
  priority: 1 | 2 | 3 | 4 | 5;
  expires_at?: string;
  created_at: string;
  updated_at: string;
}

export type NotificationType = 
  | 'student_submitted_series'
  | 'student_submitted_assignment'
  | 'teacher_graded_series' 
  | 'teacher_graded_assignment'
  | 'course_announcement'
  | 'system_notification';
```

### 实施步骤规划

#### Phase 1: 基础架构 (MVP)
1. 创建数据库迁移文件
2. 实现 NotificationService 基础功能
3. 创建核心UI组件
4. 在现有业务流程中集成通知触发

#### Phase 2: 用户体验优化
1. 添加通知偏好设置
2. 实现智能通知合并
3. 优化性能（Redis缓存）
4. 添加通知音效和动画

#### Phase 3: 高级功能
1. 实时通知推送（WebSocket）
2. 外部通知渠道（邮件）
3. 通知模板系统
4. 批量操作功能

### 性能优化策略

#### 数据库优化
- 按用户ID和时间分区
- 定期清理过期通知
- 使用数据库触发器优化计数

#### 前端优化
- 虚拟滚动处理大量通知
- 防抖处理频繁的标记已读操作
- 本地缓存减少API调用

#### 缓存策略
- Redis 缓存未读通知数量
- 浏览器本地存储最近通知
- 服务端查询结果缓存

### 安全考虑

#### 权限控制
- 严格的RLS策略防止越权访问
- 通知创建权限验证
- 敏感信息脱敏处理

#### 防刷保护
- 通知创建频率限制
- 重复通知检测和合并
- 异常行为监控