# 系列问答功能实现计划

## 项目概述
基于现有LMS系统，新增系列问答功能模块，允许教师创建结构化的问答序列，适用于写作练习、调查问卷、案例分析等多种教学场景。
系列问答功能描述
系列问答是一种结构化的问答模式，允许教师创建一系列相互关联、有特定顺序的简答题。这种模式适用于多种教学场景，不限于写作练习。

核心功能
结构化问题设计
教师可创建多个相互关联的问题
每个问题有标题和描述
问题按特定顺序排列，形成完整的思考路径
灵活的应用场景
分步骤写作练习
调查问卷
反思日记
案例分析
实验报告
项目规划
AI评分集成
学生完成所有问题后自动跳转到AI评分界面
教师可预设评分标准和AI提示
AI提供整体评价而非单个问题评分
进度追踪
学生可看到完成进度
可保存部分完成的回答
字数统计功能
评估反馈
AI生成的评分和反馈
教师可查看并修改AI评分
学生可查看详细反馈
这种功能特别适合需要引导式思考或分步骤完成的学习任务，帮助学生通过结构化的问题序列，逐步构建完整的思考或分析过程。


## 技术架构分析
- **前端框架**: React + TypeScript + Vite
- **后端**: Supabase 客户端 + 服务层
- **数据库**: PostgreSQL (Supabase)
- **API方式**: 直接使用Supabase客户端进行数据库操作
- **现有基础**: 已有课程创建、问答系统、AI评分功能

## 实现方式说明

### 不使用Edge Functions的原因
1. **简化部署**: 避免额外的函数部署和管理
2. **降低复杂度**: 减少分布式系统的复杂性
3. **更好的调试**: 前端直接调用，便于调试和错误追踪
4. **成本考虑**: 减少函数调用费用

### 替代方案
1. **直接数据库操作**: 使用Supabase客户端直接操作数据库
2. **服务层封装**: 在前端服务层中封装业务逻辑
3. **现有AI服务**: 复用现有的 `aiService.ts` 进行AI评分
4. **事务处理**: 使用Supabase的事务功能确保数据一致性

### 具体实现策略
- **创建系列问答**: 在 `seriesQuestionnaireService.ts` 中使用 `supabase.from().insert()`
- **提交答案**: 使用 `supabase.from().upsert()` 支持草稿保存
- **AI评分**: 调用现有的 `sendMessageToAI()` 方法，然后存储结果
- **权限控制**: 利用Supabase的RLS策略进行权限管理

## 实施计划

### 第一阶段：数据库设计与迁移 (1-2天)

#### 1.1 创建系列问答相关数据表
- [ ] 创建 `series_questionnaires` 表（系列问答主表）
- [ ] 创建 `series_questions` 表（系列问题表）
- [ ] 创建 `series_submissions` 表（学生提交表）
- [ ] 创建 `series_ai_gradings` 表（AI评分表）

#### 1.2 数据库迁移文件
- [ ] 编写 Supabase 迁移文件
- [ ] 设置表关系和约束
- [ ] 添加必要的索引和RLS策略

### 第二阶段：类型定义与接口设计 (1天) ✅ 已完成

#### 2.1 TypeScript 类型定义 ✅
- [x] 在 `src/types/course.ts` 中添加系列问答相关类型
- [x] 定义 `SeriesQuestionnaire`、`SeriesQuestion`、`SeriesSubmission` 等类型
- [x] 扩展现有 `LessonType` 和 `LessonContent` 类型

#### 2.2 API 接口设计 ✅
- [x] 设计创建/编辑系列问答的API接口
- [x] 设计学生提交答案的API接口
- [x] 设计AI评分的API接口

#### 2.3 完成的文件和功能
- [x] `src/types/course.ts` - 添加了完整的系列问答类型定义
- [x] `src/types/series-questionnaire.ts` - 专门的API接口类型定义
- [x] `src/services/seriesQuestionnaireService.ts` - 完整的服务层实现
- [x] `docs/api/series-questionnaire-api.md` - API接口规范文档
- [x] 更新了 `courseService.ts` 中的类型映射
- [x] 更新了 `gamificationService.ts` 中的经验值配置
- [x] 更新了 Edge Functions 中的类型定义

### 第三阶段：后端服务层开发 (1-2天)

#### 3.1 数据服务层扩展
- [ ] 修改现有的 `src/services/seriesQuestionnaireService.ts`
  - [ ] 移除Edge Function调用，改为直接使用Supabase客户端
  - [ ] 实现系列问答的CRUD操作方法（创建、读取、更新、删除）
  - [ ] 实现学生答案提交和保存功能
  - [ ] 添加数据验证和错误处理逻辑

#### 3.2 AI评分服务集成
- [ ] 扩展现有的 `src/services/aiService.ts`
  - [ ] 添加系列问答专用的AI评分方法
  - [ ] 实现批量问答的整体评分逻辑
  - [ ] 使用现有的OpenRouter API进行评分
  - [ ] 集成到现有的AI服务工作流中

#### 3.3 数据库操作优化
- [ ] 使用Supabase客户端直接操作数据库
  - [ ] 参考现有的 `courseService.ts` 模式
  - [ ] 实现事务处理确保数据一致性
  - [ ] 添加性能优化和缓存策略
  - [ ] 实现权限检查和用户认证

#### 3.4 游戏化系统集成
- [ ] 扩展 `src/services/gamificationService.ts`
  - [ ] 为系列问答添加经验值规则（已配置55经验值）
  - [ ] 实现技能经验分配逻辑
  - [ ] 集成成就系统检查
  - [ ] 添加时间线活动记录

### 第四阶段：教师端界面开发 (3-4天)

#### 4.1 课程创建器集成
- [ ] 在 `LessonEditor.tsx` 中添加系列问答类型支持
- [ ] 创建 `SeriesQuestionnaireEditor` 组件
- [ ] 实现问题的添加、编辑、排序功能

#### 4.2 系列问答编辑器组件
- [ ] 创建 `SeriesQuestionEditor` 组件（单个问题编辑）
- [ ] 创建 `SeriesQuestionList` 组件（问题列表管理）
- [ ] 实现拖拽排序功能
- [ ] 添加AI评分标准设置界面

#### 4.3 预览功能
- [ ] 创建教师预览界面
- [ ] 实现问题流程预览
- [ ] 添加字数统计和进度显示

### 第五阶段：学生端界面开发 (3-4天)

#### 5.1 答题界面
- [ ] 创建 `SeriesQuestionnaireStudent` 组件
- [ ] 实现逐步答题界面
- [ ] 添加进度条和字数统计

#### 5.2 答题体验优化
- [x] 实现问题间的导航
  - [x] 添加视图模式切换（逐题模式/全部显示模式）
  - [x] 实现上一题/下一题导航按钮
  - [x] 添加题目导航面板，支持快速跳转
  - [x] 显示答题进度和状态指示器
  - [x] 优化单题模式的UI布局

- [x] 添加提交确认机制
  - [x] 实现提交前必填题验证
  - [x] 添加提交确认对话框
  - [x] 显示详细的提交信息（题目数量、字数、用时等）
  - [x] 添加提交前检查清单
  - [x] 优化提交流程的用户体验

#### 5.3 结果展示
- [ ] 创建答题完成页面
- [ ] 实现AI评分结果展示
- [ ] 添加详细反馈显示
- [ ] 集成现有的庆祝动效

### 第六阶段：AI评分集成 (2天)

#### 6.1 AI评分逻辑（已在第三阶段集成）
- [ ] 使用现有的 `aiService.ts` 中的 `sendMessageToAI` 方法
- [ ] 在 `seriesQuestionnaireService.ts` 中实现评分逻辑
- [ ] 构建评分提示词，包含问题和学生答案
- [ ] 直接将评分结果存储到数据库
- [ ] 实现评分结果的检索和管理

#### 6.2 评分界面
- [ ] 创建AI评分设置界面
- [ ] 实现评分结果展示组件
- [ ] 添加教师评分覆盖功能
- [ ] 集成到现有的课程管理界面

### 第七阶段：路由与导航集成 (1天)

#### 7.1 路由配置
- [ ] 在 `src/routes/index.tsx` 中添加新路由
- [ ] 配置教师和学生的访问权限
- [ ] 集成到现有课程页面结构

#### 7.2 导航集成
- [ ] 在课程创建器中添加系列问答选项
- [ ] 在学生课程页面中集成答题入口
- [ ] 更新面包屑导航

### 第八阶段：游戏化集成 (1天)

#### 8.1 技能经验分配
- [ ] 在系列问答中标记技能类型
- [ ] 集成现有的游戏化服务
- [ ] 实现完成后的经验值奖励

#### 8.2 成就系统
- [ ] 添加系列问答相关成就
- [ ] 实现完成里程碑奖励

### 第九阶段：测试与优化 (2-3天)

#### 9.1 功能测试
- [ ] 单元测试编写
- [ ] 集成测试
- [ ] 用户体验测试

#### 9.2 性能优化
- [ ] 数据库查询优化
- [ ] 前端性能优化
- [ ] 缓存策略实现

#### 9.3 错误处理
- [ ] 添加错误边界
- [ ] 实现优雅的错误提示
- [ ] 添加数据验证

### 第十阶段：文档与部署 (1天)

#### 10.1 文档编写
- [ ] 用户使用文档
- [ ] 开发者文档
- [ ] API文档更新

#### 10.2 部署准备
- [ ] 生产环境配置
- [ ] 数据库迁移执行
- [ ] 功能开关配置

## 关键文件清单

### 新增文件
```
src/types/series-questionnaire.ts
src/services/seriesQuestionnaireService.ts
src/components/course/series-questionnaire/
├── SeriesQuestionnaireEditor.tsx
├── SeriesQuestionEditor.tsx
├── SeriesQuestionList.tsx
├── SeriesQuestionnaireStudent.tsx
└── SeriesQuestionnaireResult.tsx
supabase/migrations/[timestamp]_add_series_questionnaire.sql
```

### 修改文件
```
src/types/course.ts
src/components/course/LessonEditor.tsx
src/routes/index.tsx
src/services/courseService.ts
```

## 预估时间
- **总开发时间**: 12-15个工作日（简化后端减少3-5天）
- **测试时间**: 2-3个工作日
- **部署时间**: 0.5个工作日（无需部署Edge Functions）

## 风险评估
1. **AI评分准确性**: 需要充分测试不同类型问答的评分效果
2. **性能问题**: 长系列问答可能影响加载速度
3. **用户体验**: 需要确保答题流程顺畅自然
4. **数据一致性**: 多步骤提交过程中的数据完整性

## 成功标准
1. 教师能够创建包含3-10个问题的系列问答
2. 学生能够顺畅完成答题流程
3. AI评分能够提供有意义的反馈
4. 系统性能满足现有标准
5. 与现有游戏化系统无缝集成

## 实施进度

### 阶段 1: 数据库设计与迁移 ✅ **已完成**
- [x] 创建系列问答相关数据表
  - ✅ `series_questionnaires` - 系列问答主表
  - ✅ `series_questions` - 问题表
  - ✅ `series_submissions` - 学生提交表
  - ✅ `series_ai_gradings` - AI评分表
- [x] 设置数据库迁移文件
  - ✅ 创建表结构和索引
  - ✅ 添加外键约束和触发器
  - ✅ 创建辅助函数和视图
- [x] 配置 RLS 策略
  - ✅ 所有表启用 RLS
  - ✅ 学生只能查看自己的提交
  - ✅ 教师可以管理自己课程的问答
  - ✅ 系统可以创建AI评分记录

#### 已创建的数据库对象：
- **表**: `series_questionnaires`, `series_questions`, `series_submissions`, `series_ai_gradings`
- **函数**:
  - `get_series_questionnaire_details()` - 获取问卷详情
  - `get_student_submission_status()` - 获取学生提交状态
  - `calculate_submission_word_count()` - 计算字数
  - `update_submission_word_count()` - 更新字数触发器函数
- **视图**: `series_questionnaire_stats` - 问卷统计视图
- **触发器**: 自动更新时间戳和字数统计

#### 测试数据：
- ✅ 创建了测试问卷 "狗狗知识反思问答"
- ✅ 添加了4个测试问题
- ✅ 验证了所有函数和视图正常工作

### 下一步工作：
**阶段 2: TypeScript 类型定义** - 准备开始
- [ ] 创建 `src/types/series-questionnaire.ts`
- [ ] 定义所有相关接口和类型
- [ ] 与现有类型系统集成

## 总结

系列问答功能将为LMS系统增加强大的结构化问答能力，支持多种教学场景，并与现有的AI评分和技能系统深度集成。通过分阶段实施，可以确保功能的稳定性和用户体验的优化。

**当前状态**: 数据库层已完全实现并测试通过，可以开始前端开发工作。
