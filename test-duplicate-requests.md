# 第一阶段步骤一测试指南

## 🎯 测试目标
验证React Query重复请求修复是否生效，确保同一课程数据只被请求1次而不是3次。

## 📋 测试步骤

### 1. 清除浏览器缓存
```bash
# 在浏览器中：
# 1. 打开开发者工具 (F12)
# 2. 右键点击刷新按钮
# 3. 选择"清空缓存并硬性重新加载"
```

### 2. 启动开发服务器
```bash
cd /Users/liuhuaize/Desktop/create-connect-lms
npm run dev
```

### 3. 监控控制台日志
在浏览器开发者工具的Console标签页中，查看以下关键日志：

**修复前的问题表现：**
- ❌ 看到3次 "📚 正在获取课程详情" 日志
- ❌ 总加载时间超过6秒
- ❌ 同一个courseId被请求多次

**修复后的预期表现：**
- ✅ 只看到1次 "📚 正在获取课程详情" 日志
- ✅ 总加载时间降到2-3秒内
- ✅ 看到 "🚫 阻止重复的课程数据请求" 日志（如果有重复请求尝试）

### 4. 测试具体页面
访问任意课程页面，例如：
```
http://localhost:5173/course/[课程ID]
```

### 5. 验证缓存效果
1. 刷新页面，观察是否从缓存加载
2. 切换到其他页面再返回，验证缓存是否生效
3. 检查是否还有重复请求

## 🔍 关键监控指标

### 控制台日志检查清单
- [ ] 只有1次课程详情请求，不是3次
- [ ] 总加载时间从6.9秒降到2秒内
- [ ] 没有重复的Timer日志
- [ ] 缓存配置生效（15分钟强缓存）

### 网络面板检查
1. 打开开发者工具的Network标签页
2. 刷新页面
3. 查看对Supabase的请求数量
4. 验证相同的课程查询只发送一次

## 📊 性能对比

| 指标 | 修复前 | 修复后 | 改善目标 |
|------|--------|--------|----------|
| 课程数据请求次数 | 3次 | 1次 | ✅ 67%减少 |
| 总加载时间 | 6.9秒 | <2秒 | ✅ 71%+提升 |
| 重复请求 | 有 | 无 | ✅ 完全消除 |

## 🚨 故障排除

### 如果仍然看到重复请求：
1. 检查是否有多个useCourseData hook被同时使用
2. 确认React StrictMode是否导致双重挂载
3. 验证查询键是否完全一致

### 如果缓存不生效：
1. 检查浏览器是否禁用了缓存
2. 确认EMERGENCY_CACHE_CONFIG配置是否正确应用
3. 查看是否有其他代码强制刷新缓存

## ✅ 成功标志
- 控制台只显示1次课程数据请求
- 页面加载时间显著减少
- 没有"阻止重复请求"的警告日志
- 缓存在15分钟内有效

## 🔄 如果需要回滚
如果修复导致问题，可以快速回滚：
```bash
git checkout HEAD -- src/pages/course/hooks/useCourseData.ts
git checkout HEAD -- src/pages/course/CourseDetailsPage.tsx
git checkout HEAD -- src/App.tsx
```

## 📞 下一步
测试通过后，可以继续实施第一阶段的步骤二：优化课时数据加载策略。

## 🎯 已修复的页面
1. ✅ **CoursePage.tsx** - 课程播放页面 (使用 useCourseData hook)
2. ✅ **CourseDetailsPage.tsx** - 课程详情页面 (已改为使用 useCourseData hook)
3. ✅ **CourseCreator.tsx** - 课程创建器 (使用 useCourseDataLoader，已有防重复机制)

## 🧪 测试课程详情页面
访问任意课程详情页面，例如：
- http://localhost:8081/course/[courseId]/details

检查控制台是否只有1次课程数据请求，没有重复请求。
